(()=>{var _=w=>Object.fromEntries(w.map(t=>[t,!0])),m=class{static consonant={k:"\u0F40",kh:"\u0F41",g:"\u0F42",gh:"\u0F42\u0FB7","g+h":"\u0F42\u0FB7",ng:"\u0F44",c:"\u0F45",ch:"\u0F46",j:"\u0F47",ny:"\u0F49",T:"\u0F4A","-t":"\u0F4A",Th:"\u0F4B","-th":"\u0F4B",D:"\u0F4C","-d":"\u0F4C",Dh:"\u0F4C\u0FB7","D+h":"\u0F4C\u0FB7","-dh":"\u0F4C\u0FB7","-d+h":"\u0F4C\u0FB7",N:"\u0F4E","-n":"\u0F4E",t:"\u0F4F",th:"\u0F50",d:"\u0F51",dh:"\u0F51\u0FB7","d+h":"\u0F51\u0FB7",n:"\u0F53",p:"\u0F54",ph:"\u0F55",b:"\u0F56",bh:"\u0F56\u0FB7","b+h":"\u0F56\u0FB7",m:"\u0F58",ts:"\u0F59",tsh:"\u0F5A",dz:"\u0F5B",dzh:"\u0F5B\u0FB7","dz+h":"\u0F5B\u0FB7",w:"\u0F5D",zh:"\u0F5E",z:"\u0F5F","'":"\u0F60",y:"\u0F61",r:"\u0F62",l:"\u0F63",sh:"\u0F64",Sh:"\u0F65","-sh":"\u0F65",s:"\u0F66",h:"\u0F67",W:"\u0F5D",Y:"\u0F61",R:"\u0F6A",f:"\u0F55\u0F39",v:"\u0F56\u0F39"};static subjoined={k:"\u0F90",kh:"\u0F91",g:"\u0F92",gh:"\u0F92\u0FB7","g+h":"\u0F92\u0FB7",ng:"\u0F94",c:"\u0F95",ch:"\u0F96",j:"\u0F97",ny:"\u0F99",T:"\u0F9A","-t":"\u0F9A",Th:"\u0F9B","-th":"\u0F9B",D:"\u0F9C","-d":"\u0F9C",Dh:"\u0F9C\u0FB7","D+h":"\u0F9C\u0FB7","-dh":"\u0F9C\u0FB7","-d+h":"\u0F9C\u0FB7",N:"\u0F9E","-n":"\u0F9E",t:"\u0F9F",th:"\u0FA0",d:"\u0FA1",dh:"\u0FA1\u0FB7","d+h":"\u0FA1\u0FB7",n:"\u0FA3",p:"\u0FA4",ph:"\u0FA5",b:"\u0FA6",bh:"\u0FA6\u0FB7","b+h":"\u0FA6\u0FB7",m:"\u0FA8",ts:"\u0FA9",tsh:"\u0FAA",dz:"\u0FAB",dzh:"\u0FAB\u0FB7","dz+h":"\u0FAB\u0FB7",w:"\u0FAD",zh:"\u0FAE",z:"\u0FAF","'":"\u0FB0",y:"\u0FB1",r:"\u0FB2",l:"\u0FB3",sh:"\u0FB4",Sh:"\u0FB5","-sh":"\u0FB5",s:"\u0FB6",h:"\u0FB7",a:"\u0FB8",W:"\u0FBA",Y:"\u0FBB",R:"\u0FBC"};static vowel={a:"\u0F68",A:"\u0F71",i:"\u0F72",I:"\u0F71\u0F72",u:"\u0F74",U:"\u0F71\u0F74",e:"\u0F7A",ai:"\u0F7B",o:"\u0F7C",au:"\u0F7D","-i":"\u0F80","-I":"\u0F71\u0F80","r-i":"\u0FB2\u0F80","r-I":"\u0FB2\u0F71\u0F80","l-i":"\u0FB3\u0F80","l-I":"\u0FB3\u0F71\u0F80"};static complex_vowel={"r-i":["\u0F62\u0F80","\u0FB2\u0F80"],"r-I":["\u0F62\u0F71\u0F80","\u0FB2\u0F71\u0F80"],"l-i":["\u0F63\u0F80","\u0FB3\u0F80"],"l-I":["\u0F63\u0F71\u0F80","\u0FB3\u0F71\u0F80"]};static finals={M:["\u0F7E","M"],"~M`":["\u0F82","M"],"~M":["\u0F83","M"],X:["\u0F37","X"],"~X":["\u0F35","X"],H:["\u0F7F","H"],"?":["\u0F84","?"],"^":["\u0F39","^"],"&":["\u0F85","&"]};static other={0:"\u0F20",1:"\u0F21",2:"\u0F22",3:"\u0F23",4:"\u0F24",5:"\u0F25",6:"\u0F26",7:"\u0F27",8:"\u0F28",9:"\u0F29"," ":"\u0F0B","*":"\u0F0C","/":"\u0F0D","//":"\u0F0E",";":"\u0F0F","|":"\u0F11","!":"\u0F08",":":"\u0F14",_:" ","=":"\u0F34","<":"\u0F3A",">":"\u0F3B","(":"\u0F3C",")":"\u0F3D","@":"\u0F04","#":"\u0F05",$:"\u0F06","%":"\u0F07"};static special=_([".","+","-","~","^","?","`","]"]);static superscripts={r:_(["k","g","ng","j","ny","t","d","n","b","m","ts","dz","k+y","g+y","m+y","b+w","ts+w","g+w"]),l:_(["k","g","ng","c","j","t","d","p","b","h"]),s:_(["k","g","ng","ny","t","d","n","p","b","m","ts","k+y","g+y","p+y","b+y","m+y","k+r","g+r","p+r","b+r","m+r","n+r"])};static subscripts={y:_(["k","kh","g","p","ph","b","m","r+k","r+g","r+m","s+k","s+g","s+p","s+b","s+m"]),r:_(["k","kh","g","t","th","d","n","p","ph","b","m","sh","s","h","dz","s+k","s+g","s+p","s+b","s+m","s+n"]),l:_(["k","g","b","r","s","z"]),w:_(["k","kh","g","c","ny","t","d","ts","tsh","zh","z","r","l","sh","s","h","g+r","d+r","ph+y","r+g","r+ts"])};static prefixes={g:_(["c","ny","t","d","n","ts","zh","z","y","sh","s"]),d:_(["k","g","ng","p","b","m","k+y","g+y","p+y","b+y","m+y","k+r","g+r","p+r","b+r"]),b:_(["k","g","c","t","d","ts","zh","z","sh","s","r","l","k+y","g+y","k+r","g+r","r+l","s+l","r+k","r+g","r+ng","r+j","r+ny","r+t","r+d","r+n","r+ts","r+dz","s+k","s+g","s+ng","s+ny","s+t","s+d","s+n","s+ts","r+k+y","r+g+y","s+k+y","s+g+y","s+k+r","s+g+r","l+d","l+t","k+l","s+r","z+l","s+w"]),m:_(["kh","g","ng","ch","j","ny","th","d","n","tsh","dz","kh+y","g+y","kh+r","g+r"]),"'":_(["kh","g","ch","j","th","d","ph","b","tsh","dz","kh+y","g+y","ph+y","b+y","kh+r","g+r","d+r","ph+r","b+r"])};static suffixes=_(["'","g","ng","d","n","b","m","r","l","s","N","T","-n","-t"]);static suff2={s:_(["g","ng","b","m"]),d:_(["n","r","l"])};static affixedsuff2=_(["ng","m"]);static ambiguous={dgs:[1,"dgas"],dngs:[1,"dngas"],"'gs":[1,"'gas"],"'bs":[1,"'bas"],dbs:[1,"dbas"],dms:[1,"dmas"],bgs:[0,"bags"],mngs:[0,"mangs"],mgs:[0,"mags"],gnd:[1,"gnad"]};static tib_top={\u0F40:"k",\u0F41:"kh",\u0F42:"g",\u0F43:"g+h",\u0F44:"ng",\u0F45:"c",\u0F46:"ch",\u0F47:"j",\u0F49:"ny",\u0F4A:"T",\u0F4B:"Th",\u0F4C:"D",\u0F4D:"D+h",\u0F4E:"N",\u0F4F:"t",\u0F50:"th",\u0F51:"d",\u0F52:"d+h",\u0F53:"n",\u0F54:"p",\u0F55:"ph",\u0F56:"b",\u0F57:"b+h",\u0F58:"m",\u0F59:"ts",\u0F5A:"tsh",\u0F5B:"dz",\u0F5C:"dz+h",\u0F5D:"w",\u0F5E:"zh",\u0F5F:"z",\u0F60:"'",\u0F61:"y",\u0F62:"r",\u0F63:"l",\u0F64:"sh",\u0F65:"Sh",\u0F66:"s",\u0F67:"h",\u0F68:"a",\u0F69:"k+Sh",\u0F6A:"R"};static tib_subjoined={"\u0F90":"k","\u0F91":"kh","\u0F92":"g","\u0F93":"g+h","\u0F94":"ng","\u0F95":"c","\u0F96":"ch","\u0F97":"j","\u0F99":"ny","\u0F9A":"T","\u0F9B":"Th","\u0F9C":"D","\u0F9D":"D+h","\u0F9E":"N","\u0F9F":"t","\u0FA0":"th","\u0FA1":"d","\u0FA2":"d+h","\u0FA3":"n","\u0FA4":"p","\u0FA5":"ph","\u0FA6":"b","\u0FA7":"b+h","\u0FA8":"m","\u0FA9":"ts","\u0FAA":"tsh","\u0FAB":"dz","\u0FAC":"dz+h","\u0FAD":"w","\u0FAE":"zh","\u0FAF":"z","\u0FB0":"'","\u0FB1":"y","\u0FB2":"r","\u0FB3":"l","\u0FB4":"sh","\u0FB5":"Sh","\u0FB6":"s","\u0FB7":"h","\u0FB8":"a","\u0FB9":"k+Sh","\u0FBA":"W","\u0FBB":"Y","\u0FBC":"R"};static tib_vowel={"\u0F71":"A","\u0F72":"i","\u0F73":"I","\u0F74":"u","\u0F75":"U","\u0F7A":"e","\u0F7B":"ai","\u0F7C":"o","\u0F7D":"au","\u0F80":"-i"};static tib_vowel_long={i:"I",u:"U","-i":"-I"};static tib_final={"\u0F35":["~X","X"],"\u0F37":["X","X"],"\u0F39":["^","^"],"\u0F7E":["M","M"],"\u0F7F":["H","H"],"\u0F82":["~M`","M"],"\u0F83":["~M","M"],"\u0F84":["?","?"],"\u0F85":["&","&"]};static tib_caret={ph:"f",b:"v"};static tib_other={" ":"_","\u0F04":"@","\u0F05":"#","\u0F06":"$","\u0F07":"%","\u0F08":"!","\u0F0B":" ","\u0F0C":"*","\u0F0D":"/","\u0F0E":"//","\u0F0F":";","\u0F11":"|","\u0F14":":","\u0F20":"0","\u0F21":"1","\u0F22":"2","\u0F23":"3","\u0F24":"4","\u0F25":"5","\u0F26":"6","\u0F27":"7","\u0F28":"8","\u0F29":"9","\u0F34":"=","\u0F3A":"<","\u0F3B":">","\u0F3C":"(","\u0F3D":")"};static tib_stack=_(["b+l","b+r","b+y","c+w","d+r","d+r+w","d+w","g+l","g+r","g+r+w","g+w","g+y","h+r","h+w","k+l","k+r","k+w","k+y","kh+r","kh+w","kh+y","l+b","l+c","l+d","l+g","l+h","l+j","l+k","l+ng","l+p","l+t","l+w","m+r","m+y","n+r","ny+w","p+r","p+y","ph+r","ph+y","ph+y+w","r+b","r+d","r+dz","r+g","r+g+w","r+g+y","r+j","r+k","r+k+y","r+l","r+m","r+m+y","r+n","r+ng","r+ny","r+t","r+ts","r+ts+w","r+w","s+b","s+b+r","s+b+y","s+d","s+g","s+g+r","s+g+y","s+k","s+k+r","s+k+y","s+l","s+m","s+m+r","s+m+y","s+n","s+n+r","s+ng","s+ny","s+p","s+p+r","s+p+y","s+r","s+t","s+ts","s+w","sh+r","sh+w","t+r","t+w","th+r","ts+w","tsh+w","z+l","z+w","zh+w"]);static initialized=!1;static static_init(){if(this.initialized)return;this.initialized=!0;let t=i=>(i+"").replace(/\W/g,"\\$&"),e=(i,u)=>i.length<u.length?1:i.length>u.length||i<u?-1:i>u?1:0,l=Object.assign({},this.consonant,this.subjoined,this.vowel,this.finals,this.other);l=Object.keys(l).filter(i=>i.length>1).sort(e);let s=l.map(t).join("|");s=`(${s}|\\\\u....|\\\\U........|\\\\.|\r
|.)`,this.tokens_regex=new RegExp(s,"s")}consonant(t){return this.constructor.consonant[t]}subjoined(t){return this.constructor.subjoined[t]}vowel(t){return this.constructor.vowel[t]}finals(t){return this.constructor.finals[t]}complex_vowel(t){return this.constructor.complex_vowel[t]}other(t){return this.constructor.other[t]}is_special(t){return this.constructor.special[t]}is_superscript(t){return!!this.constructor.superscripts[t]}superscript(t,e){let l=this.constructor.superscripts[t];return l&&l[e]}is_subscript(t){return!!this.constructor.subscripts[t]}subscript(t,e){let l=this.constructor.subscripts[t];return l&&l[e]}is_prefix(t){return!!this.constructor.prefixes[t]}prefix(t,e){let l=this.constructor.prefixes[t];return l&&l[e]}is_suffix(t){return this.constructor.suffixes[t]}is_suff2(t){return!!this.constructor.suff2[t]}suff2(t,e){let l=this.constructor.suff2[t];return l&&l[e]}affixedsuff2(t){return this.constructor.affixedsuff2[t]}ambiguous(t){return this.constructor.ambiguous[t]}tib_top(t){return this.constructor.tib_top[t]}tib_subjoined(t){return this.constructor.tib_subjoined[t]}tib_vowel(t){return this.constructor.tib_vowel[t]}tib_vowel_long(t){return this.constructor.tib_vowel_long[t]}tib_final(t){return this.constructor.tib_final[t]}tib_caret(t){return this.constructor.tib_caret[t]}tib_other(t){return this.constructor.tib_other[t]}tib_stack(t){return this.constructor.tib_stack[t]}constructor({check:t=!0,check_strict:e=!0,fix_spacing:l=!0,leave_dubious:s=!1,sloppy:i=!1,pass_through:u=!1}={}){if(this.constructor.static_init(),e&&!t)throw new Error("Cannot have 'check_strict' without 'check'.");this.check=t,this.check_strict=e,this.fix_spacing=l,this.leave_dubious=s,this.sloppy=i,this.pass_through=u,this.warnings=[]}fix_sloppy(t){return t.replaceAll("\u02BC","'").replaceAll("\u02B9","'").replaceAll("\u2018","'").replaceAll("\u2019","'").replaceAll("\u02BE","'").replaceAll("...","\\u0f0b\\u0f0b\\u0f0b").replaceAll(" (","_(").replaceAll(") ",")_").replaceAll("/ ","/_").replaceAll(" 0","_0").replaceAll(" 1","_1").replaceAll(" 2","_2").replaceAll(" 3","_3").replaceAll(" 4","_4").replaceAll(" 5","_5").replaceAll(" 6","_6").replaceAll(" 7","_7").replaceAll(" 8","_8").replaceAll(" 9","_9").replaceAll("_ ","__").replaceAll("G","g").replaceAll("K","k").replaceAll("C","c").replaceAll("B","b").replaceAll("P","p").replaceAll("L","l").replaceAll("Z","z").replaceAll(" b "," ba ").replaceAll(" b'i "," ba'i ").replaceAll(" m "," ma ").replaceAll(" m'i "," ma'i ").replaceAll("Ts","ts").replaceAll("Dz","dz").replaceAll("Ny","ny").replaceAll("Ng","ng").replaceAll(" (","(").replaceAll(") ",")").replaceAll("\u0F3C","(").replaceAll("\u0F3D",")").replaceAll("\uFF1A",":").replaceAll("H ","H").replace(/(^|[^aeiouAIU])H/g,"$1h").replace(/(^|[^aeiouAIU~])M/g,"$1m").replace(/S($|[^h])/g,"s$1")}is_combining(t){let e=t.charCodeAt(0);return e>3953&&e<3972||e<3981&&e>4028}unicode_escape(t,e){let l=t.substring(2);if(l=="")return null;if(!l.match(/^[0-9a-fA-F]+$/))return this.warn(`line ${e}: "${l}": invalid hex code.`),"";let s=parseInt(l,16);return String.fromCodePoint(s)}warn(t){this.warnings.push(t)}get_warnings(){return this.warnings}to_unicode(t,e=null){let l=1,s=0,i="";this.warnings=[];let u=_(((e||"")+"").split(""));this.fix_spacing&&(t=t.trimStart()),this.sloppy?t=this.fix_sloppy(t):t=t.replaceAll("\u02BC","'").replaceAll("\u02B9","'").replaceAll("\u2018","'").replaceAll("\u2019","'").replaceAll("\u02BE","'");let f=t.split(this.constructor.tokens_regex).filter(r=>r!=="");f.push(null);let a=0,n;t:for(;(n=f[a])!==null;){let r;if(u[n]){i+=n,a++;continue t}if(n==="["){let o=1;a++;e:for(;(n=f[a++])!==null;){if(n==="["&&o++,n==="]"&&o--,o===0)continue t;if((n.startsWith("\\u")||n.startsWith("\\U"))&&(r=this.unicode_escape(n,l),r!==null)){i+=r;continue e}n.startsWith("\\")?r=n.substring(1):r=n,i+=r}this.warn(`line ${l}: Unfinished [non-Wylie stuff].`);break t}if(r=this.other(n)){if(i+=r,a++,s++,n===" "&&this.fix_spacing)for(;f[a]===" ";)a++;continue t}if(this.vowel(n)||this.consonant(n)){let{uni:o,toks:c,warns:h}=this._to_unicode_one_tsekbar(f,a),d=f.slice(a,a+c).join("");a+=c,s++,h.length>0&&this.leave_dubious?i+="["+d+"]":i+=o;for(let g of h)this.warn(`line ${l}: "${d}": ${g}`);continue t}if(n==="\uFEFF"||n==="\u200B"){a++;continue t}if((n.startsWith("\\u")||n.startsWith("\\U"))&&(r=this.unicode_escape(n,l),r!==null)){a++,i+=r;continue t}if(n.startsWith("\\")){i+=n.substring(1),a++;continue t}if(n===`\r
`||n===`
`||n==="\r"){if(l++,i+=n,a++,this.fix_spacing)for(;f[a]===" ";)a++;continue t}(this.is_special(n)||n.match(/[a-zA-Z]/))&&this.warn(`line ${l}: Unexpected character "${n}".`),i+=n,a++}return s===0&&this.warn("No Tibetan characters found!"),i}_to_unicode_one_tsekbar(t,e){let l=e,s=t[e],i,u,f=null,a,n,r,o,c=!0,h=[],d=null,g="",p=[],b="PREFIX";for(;s!==null&&(this.vowel(s)||this.consonant(s))&&!o;)if(r=f,{uni:i,toks:u,cons:f,cons_a:a,warns:n,visarga:o}=this._to_unicode_one_stack(t,e),e+=u,p=p.concat(n),s=t[e],g+=i,!!this.check)if(b==="PREFIX"&&f){if(h.push(f),this.is_prefix(f)){let y=this.check_strict?this._consonant_string(t,e):s||"";y!==""&&!this.prefix(f,y)&&(y=y.replaceAll("+",""),p.push(`Prefix "${f}" does not occur before "${y}".`))}else p.push(`Invalid prefix consonant "${f}".`);b="MAIN"}else f?b==="MAIN"?p.push(`Expected vowel after "${f}".`):b==="SUFF1"?(h.push(f),this.check_strict&&!this.is_suffix(f)&&p.push(`Invalid suffix consonant: "${f}".`),b="SUFF2"):b==="SUFF2"?(h.push(f),this.is_suff2(f)?this.suff2(f,r)||p.push(`"Second suffix "${f}" does not occur after "${r}".`):(!this.affixedsuff2(f)||!r==="'")&&p.push(`Invalid 2nd suffix consonant: "${f}".`),b="NONE"):b==="NONE"&&p.push(`Cannot have another consonant "${f}" after 2nd suffix.`):(b="SUFF1",d!==null?c=!1:a&&(h.push(a),d=h.length-1));if(b==="MAIN"&&f&&this.is_prefix(f)&&p.push(`Vowel expected after "${f}".`),this.check&&!p.length&&c&&d!==null){if(h.length===2&&d!==0&&this.prefix(h[0],h[1])&&this.is_suffix(h[1]))p.push(`Syllable should probably be "${h[0]}a${h[1]}".`);else if(h.length===3&&this.is_prefix(h[0])&&this.suff2("s",h[1])&&h[2]==="s"){let y=h.join(""),A=this.ambiguous(y);A&&A[0]!==d&&p.push(`Syllable should probably be "${A[1]}".`)}}return{uni:g,toks:e-l,warns:p}}_to_unicode_one_stack(t,e){let l=e,s,i,u="",f=[],a=0,n=null,r=null,o=null,c=!1,h=0,d={};if(s=t[e],i=t[e+1],i!==null&&this.is_superscript(s)&&this.superscript(s,i)){if(this.check_strict){let g=this._consonant_string(t,e+1);this.superscript(s,g)||(g=g.replaceAll("+"," "),f.push(`Superscript "${s}" does not occur above combination "${g}".`))}for(u+=this.consonant(s),a++,e++;t[e]==="^";)h++,e++}t:for(;;){if(s=t[e],this.consonant(s)||u!==""&&this.subjoined(s)){if(u+=u===""?this.consonant(s):this.subjoined(s),e++,s==="a"?n="a":(a++,o=s),s.match(/(?:g|d|D|b|dz)h/)){let p=s.replace(/(g|d|D|b|dz)h/,"$1+h");f.push(`"${s} should be "${p}".`)}for(;t[e]==="^";)h++,e++;for(let p of[0,1]){let b=t[e];if(b!==null&&this.is_subscript(b)){if(b==="l"&&a>1)break;if(this.check_strict&&!c){let y=this._consonant_string_backwards(t,e-1,l);this.subscript(b,y)||(y=y.replaceAll("+",""),f.push(`Subjoined "${b}" not expected after "${y}".`))}else this.check&&!this.subscript(b,s)&&!(p===1&&b==="w"&&s==="y")&&f.push(`Subjoined "${b}" not expected after "${s}"`);for(u+=this.subjoined(b),e++,a++;t[e]==="^";)h++,e++;s=b}else break}}if(h>0){h>1&&f.push('Cannot have more than one "^" applied to the same stack.');let g=this.finals("^");d["^"]="^",u+=g[0],h=0}if(s=t[e],s!==null&&this.vowel(s)){let g=this.complex_vowel(s);g?u+=u.length?g[1]:g[0]:(u===""&&(u+=this.vowel("a")),s!=="a"&&(u+=this.vowel(s))),e++,n=s,s!=="a"&&(r=s)}if(s=t[e],s==="+"){if(e++,c=!0,s=t[e],s===null||!this.vowel(s)&&!this.subjoined(s)){this.check&&f.push('Expected vowel or consonant after "+".');break t}this.check&&(!this.vowel(s)&&r?f.push(`Cannot subjoin consonant "${s}" after vowel "${r}" in same stack.`):s==="a"&&r&&f.push(`Cannot subjoin a-chen "${s}" after vowel "${r}" in same stack.`));continue t}break t}for(s=t[e];s!==null&&this.finals(s);){let[g,p]=this.finals(s);d[p]!==void 0?d[p]===s?f.push(`Cannot have two "${s}" applied to the same stack.`):f.push(`Cannot have "${s}" and "${d[p]}" applied to the same stack.`):(d[p]=s,u+=g),e++,o=null,s=t[e]}return t[e]==="."&&e++,a>1&&n===null&&(c?this.check&&f.push("Stack with multiple consonants should end with vowel."):(e=l+1,a=1,o=t[l],u=this.consonant(o))),(a!==1||c)&&(o=null),{uni:u,toks:e-l,cons:n?null:o,cons_a:n==="a"?o:null,warns:f,visarga:"^"in d}}_consonant_string(t,e){let l=[],s;for(;(s=t[e++])!==null;)if(!(s==="+"||s==="^")){if(!this.consonant(s))break;l.push(s)}return l.join("+")}_consonant_string_backwards(t,e,l){let s=[],i;for(;e>=l&&t[e]!==null;)if(i=t[e--],!(i==="+"||i==="^")){if(!this.consonant(i))break;s.push(i)}return s.reverse().join("+")}to_ewts(t){let e="",l=1,s=0;this.warnings=[],t=t.replaceAll("\u0F76","\u0FB2\u0F80").replaceAll("\u0F77","\u0FB2\u0F71\u0F80").replaceAll("\u0F78","\u0FB3\u0F80").replaceAll("\u0F79","\u0FB3\u0F71\u0F80").replaceAll("\u0F81","\u0F71\u0F80").replaceAll("\u0F75","\u0F71\u0F74").replaceAll("\u0F73","\u0F71\u0F72").replaceAll("\u0F00","\u0F68\u0F7C\u0F7E");let i=0,u=t.length;t:for(;i<u;){let f=t.charAt(i);if(this.tib_top(f)){let{toks:r,wylie:o,warns:c}=this._to_ewts_one_tsekbar(t,u,i);e+=o,i+=r,s++;for(let h of c)this.warn(`line ${l}: ${h}`);this.pass_through&&([i,e]=this._handle_spaces(t,i,e));continue t}let a=this.tib_other(f);if(a&&(f!==" "||!this.pass_through&&!this._followed_by_nontibetan(t,i))){e+=a,i++,s++,this.pass_through&&([i,e]=this._handle_spaces(t,i,e));continue t}if(f===`
`||f==="\r"){l++,i++,e+=f,f==="\r"&&i<u&&t.charAt(i)===`
`&&(i++,e+=`
`);continue t}if(f==="\uFEFF"||f==="\u200B"){i++;continue t}if(this.pass_through){e+=f,i++;continue t}let n=f.charCodeAt(0);if(n>=3840&&n<=4095){let r=this._format_hex(n);e+=r,i++,(this.tib_subjoined(f)||this.tib_vowel(f)||this.tib_final(f))&&this.warn(`line ${l}: Tibetan sign ${r} needs a top symbol to attach to.`);continue t}for(e+="[";!this.tib_top(f)&&(!this.tib_other(f)||f===" ")&&f!=="\r"&&f!==`
`&&(f==="["||f==="]"?e+="\\"+f:f.charCodeAt(0)>=3840&&f.charCodeAt(0)<=4095?e+=this._format_hex(f.charCodeAt(0)):e+=f,!(++i>=u));)f=t.charAt(i);e+="]"}return s===0&&this.warn("No Tibetan characters found!"),e}_format_hex(t){let e=Number(t).toString(16);for(;e.length<4;)e="0"+e;return"\\u"+e}_handle_spaces(t,e,l){let s=0;for(;e<t.length&&t.charAt(e)===" ";)e++,s++;if(s===0||e===t.length)return[e,l];let i=t.charAt(e);if(!this.tib_top(i)&&!this.tib_other(i))return[e,l];for(let u=0;u<s;u++)l+="_";return[e,l]}_followed_by_nontibetan(t,e){let l=t.length;for(;e<l&&t.charAt(e)===" ";)e++;if(e===l)return!1;let s=t.charAt(e);return!this.tib_top(s)&&!this.tib_other(s)&&s!=="\r"&&s!==`
`}_to_ewts_one_tsekbar(t,e,l){let s=l,i=[],u=[];t:for(;;){let{toks:r,stack:o,warns:c}=this._to_ewts_one_stack(t,e,l);if(u.push(o),i=i.concat(c),l+=r,o.visarga||l>=e||!this.tib_top(t.charAt(l)))break t}let f=u.length,a=f-1;if(f>1&&u[0].single_cons){let r=u[1].cons_str.replaceAll("+w","");this.prefix(u[0].single_cons,r)&&(u[0].prefix=!0)}if(f>1&&u[a].single_cons&&this.is_suffix(u[a].single_cons)&&(u[a].suffix=!0),f>2&&u[a].single_cons&&u[a-1].single_cons&&this.is_suffix(u[a-1].single_cons)&&this.is_suff2(u[a].single_cons)&&this.suff2(u[a].single_cons,u[a-1].single_cons)&&(u[a].suff2=!0,u[a-1].suffix=!0),f===2&&u[0].prefix&&u[1].suffix&&(u[0].prefix=!1),f===3&&u[0].prefix&&u[1].suffix&&u[2].suff2){let r=u.map(h=>h.single_cons).join(""),o=this.ambiguous(r),c;o?c=o[0]:(i.push(`Ambiguous syllable found: root consonant not known for "${r}".`),c=1),u[c].prefix=u[c].suffix=!1,u[c+1].suff2=!1}u[0].prefix&&this.tib_stack(u[0].single_cons+"+"+u[1].cons_str)&&(u[0].dot=!0);for(let r=1;r<u.length;r++)u[r].top=="a"&&(u[r-1].dot=!0);let n=u.map(r=>this._put_stack_together(r)).join("");return{toks:l-s,wylie:n,warns:i,stacks:u}}_put_stack_together(t){let e="";return this.tib_stack(t.cons_str)?e+=t.stack.join(""):e+=t.cons_str,t.caret&&(e+="^"),t.vowels.length>0?e+=t.vowels.join("+"):!t.prefix&&!t.suffix&&!t.suff2&&!t.cons_str.match(/a$/)&&(e+="a"),e+=t.finals.join(""),t.dot&&(e+="."),e}_to_ewts_one_stack(t,e,l){let s=l,i=[],u=null,f=null,a=null,n={top:null,stack:[],caret:!1,vowels:[],finals:[],finals_found:{},visarga:!1,cons_str:null,single_cons:null,prefix:!1,suffix:!1,suff2:!1,dot:!1},r=n.stack,o=n.vowels,c=t.charAt(l++);for(n.top=this.tib_top(c),r.push(this.tib_top(c));l<e;){c=t.charAt(l);let h;if(h=this.tib_subjoined(c))l++,r.push(h),n.finals.length>0?i.push(`Subjoined sign "${h}" found after final sign "${u}".`):o.length>0&&i.push(`Subjoined sign "${h}" found after vowel sign "${f}".`);else if(h=this.tib_vowel(c))l++,o.push(h),f===null&&(f=h),n.finals.length>0&&i.push(`Vowel sign "${h}" found after final sign "${u}".`);else if(h=this.tib_final(c))l++,[h,a]=h,h==="^"?n.caret=!0:(h==="H"&&(n.visarga=!0),u===null&&(u=h),n.finals_found[a]!==void 0?i.push(`Final sign "${h}" should not combine with final sign "${n.finals_found[a]}".`):(n.finals_found[a]=h,n.finals.push(h)));else break}if(n.top==="a"&&r.length===1&&o.length>0&&r.shift(),o.length>1&&o[0]==="A"&&this.tib_vowel_long(o[1])&&o.splice(0,2,this.tib_vowel_long(o[1])),r.length>0&&r[r.length-1]in["r","l"]&&o.length===1&&o[0]in["-i","-I"]){let h=r.pop();o[0]=h+o[0]}return n.caret&&r.length===1&&this.tib_caret(n.top)&&(n.top=r[0]=this.tib_caret(n.top),n.caret=!1),n.cons_str=r.join("+"),r.length===1&&r[0]!=="a"&&!n.caret&&o.length===0&&n.finals.length===0&&(n.single_cons=n.cons_str),{toks:l-s,stack:n,warns:i}}};var k=w=>document.getElementById(w),v=w=>w.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#x27;");k("id__txt").addEventListener("keydown",function(w){w.keyCode==13&&w.ctrlKey&&(x(),w.preventDefault())});k("id__convert").addEventListener("click",x);function x(){let w=k("id__conversion"),e=w.options[w.selectedIndex].value==="uni2wy",l=k("id__txt").value,s=k("id__leave_dubious").checked;try{let i=window.ewts=new m({leave_dubious:s,pass_through:s});if(e){let f=i.to_ewts(l);k("id__tibetan").style.display="none",k("id__wylie_out").value=f,k("id__wylie").style.display="block"}else{let f=i.to_unicode(l);k("id__wylie").style.display="none",k("id__tib_out").value=f,k("id__tibetan").style.display="block"}let u=i.get_warnings();k("warnings-inner").innerHTML=u.map(v).join("<br>"),k("warnings").style.display=u.length>0?"block":"none"}catch(i){alert(`Converter crashed - please try with a recent version of Firefox, Chrome, Safari or Edge.
`+i.message)}}})();
